# Claude Notes

## Product Docs
- `docs/game-pillars-theme.md` — Core fantasy, pillars, tone, and inspirations (Stardew Valley, Harvest Moon, Pokemon, low-poly, kawaii).
- `docs/demo-plan.md` — Target demo scope with Done/To Do status.

## Project Runtime Defaults
- Multiplayer default port: `7777` (UDP).
- **Smart IP defaults**: In editor, ConnectUI defaults to `127.0.0.1` (localhost). In exported builds, defaults to `207.32.216.76` (public server). Editor mode ignores saved prefs for IP to prevent stale overrides.
- **Dedicated server detection** (3 triggers, checked in `NetworkManager._ready()`):
  1. `DisplayServer.get_name() == "headless"` — Docker/headless export
  2. `OS.has_feature("dedicated_server")` — Godot dedicated server export
  3. `--server` or `--role=server` in `OS.get_cmdline_user_args()` — CLI flags (MCP `run_multiplayer_session` auto-passes `--role=server`)
- When dedicated mode is detected: auto-calls `host_game("Server")` + `GameManager.start_game()`, skips ConnectUI entirely, skips game world UI setup (HUD, BattleUI, etc.) and camera creation.

## Persistence Architecture (MongoDB + Express API)

### Overview
```
[Godot Game Server] --HTTP--> [Express API :3000] --MongoDB--> [MongoDB :27017]
     |                              (internal only)
     |--UDP 7777--> [Game Clients]
```
- Only the game server talks to the API. Clients get data via RPCs.
- API is internal (ClusterIP in K8s, docker network locally).
- **Editor dev (no Docker)**: SaveManager auto-falls back to file I/O (`user://save/`). No API needed.

### UUID Identity System (CRITICAL)
**Every persistent entity MUST have a stable UUID.** This is required because MongoDB documents are keyed by UUID, not by name or array index.

| Entity | UUID field | Generated by | Stored in |
|--------|-----------|-------------|-----------|
| Player | `player_id` | Express API (`crypto.randomUUID()`) on first join | `players` collection `_id`, `player_data_store[peer_id]["player_id"]` |
| Creature | `creature_id` | Server-side `_generate_uuid()` on creation | Each creature dict in party/storage arrays |

**Rules for UUIDs:**
- **New entities** (players, creatures, future items): ALWAYS generate a UUID on creation. Never rely on array index or display name as an identifier.
- **Existing entities without UUIDs**: Auto-backfilled on load via `_backfill_creature_ids()`. Same function also backfills IVs, bond data via `_backfill_creature_stats()`.
- **Cross-reference by UUID**: Held item equip/unequip, storage deposit/withdraw, battle creature references should use `creature_id` (not party index).
- **Player names are unique** (MongoDB unique index + `active_player_names` runtime check) but names are for display/lookup, NOT identity. The `player_id` UUID is the stable key.
- **If you add a new persistent entity type** (e.g. guilds, mail, auction listings), it MUST get a UUID field generated server-side.

### Express API (`api/`)
- **Tech**: Node 20, Express, MongoDB driver, TypeScript
- **Endpoints**: `GET/PUT /api/players/:id`, `GET /api/players/by-name/:name`, `POST /api/players`, `GET/PUT /api/world`, `GET /health`
- **MongoDB collections**: `players` (keyed by `_id: player_id` UUID, unique index on `player_name`), `world` (single doc `_id: "world_state"`)
- **Image**: `ghcr.io/crankymagician/mt-creature-crafting-api:latest`

### SaveManager (`scripts/autoload/save_manager.gd`)
- **Startup**: checks `SAVE_API_URL` env var → `GET /health` → sets `use_api: bool`. Falls back to file I/O if unreachable.
- **Save flow**: `save_player(data)` → `PUT /api/players/:player_id` (fire-and-forget, auto-save every 60s)
- **Load flow**: `load_player_async(name)` → `GET /api/players/by-name/:name` → emits `player_loaded(name, data)`
- **Create flow**: `create_player_async(data)` → `POST /api/players` → API generates UUID → emits `player_created(name, data)`

### Join Flow (Async, UUID-Aware)
1. Client sends `request_join(player_name)` RPC
2. Server validates name (2-16 chars, alphanumeric + underscores + spaces), checks `active_player_names`
3. Server calls `SaveManager.load_player_async(player_name)` → signal
4. If empty → `create_player_async()` (new player with UUID); if found → `_finalize_join()`
5. `_finalize_join()`: backfills creature UUIDs + IVs + bond data, stores in `player_data_store`, sends `_receive_player_data` RPC

### Docker Compose (Local Dev)
```yaml
services:
  mongodb:     # mongo:7, port 27017, volume mongo_data
  api-service: # builds ./api, port 3000, MONGO_URI
  game-server: # builds ., port 7777/udp, SAVE_API_URL
```
- `docker compose up --build -d` starts all 3 services
- Verify MongoDB: `docker exec mongodb mongosh creature_crafting --eval "db.players.find()"`

## Docker Server Build
See `docs/docker-build.md` for full build instructions (two-phase engine + game build, SCons flags, local dev).

## TestPlayer Dev Account
- **Name**: "TestPlayer" (case-insensitive match via `name.to_lower() == "testplayer"`)
- **When**: Every login, not just first creation. Runs in `_finalize_join()` after backfills.
- **Where**: Works in all builds (editor, exported, deployed server). Not gated by `OS.has_feature("editor")`.
- **What**: `_apply_testplayer_loadout(data)` in `network_manager.gd` grants:
  - All ingredients x10, all foods x5, all battle items x10, all held items x3, all recipe scrolls x1, all tools x1
  - $99,999 money
  - All recipes unlocked (`known_recipes` = every recipe ID)
  - One of every creature species at level 20 in `creature_storage` (skips species already in party/storage)
  - Storage capacity expanded to fit all creatures + 10
  - Full compendium (all items, all creatures seen + owned)
- **Normal players**: Start with 4 basic tools, $0, 1 Rice Ball starter, no recipes. The old editor-only item grant block was removed.

## Ingredient Renames (Migration System)
8 fantasy ingredient IDs were renamed to real cooking terms. Old saves are auto-migrated on login via `_backfill_ingredient_renames(data)` in `_finalize_join()`.

| Old ID | New ID | Display Name |
|--------|--------|-------------|
| `grain_core` | `flour` | Flour |
| `sweet_crystal` | `sugar` | Sugar |
| `umami_extract` | `soy_sauce` | Soy Sauce |
| `herbal_dew` | `broth` | Broth |
| `sour_essence` | `vinegar` | Vinegar |
| `spicy_essence` | `chili_powder` | Chili Powder |
| `starfruit_essence` | `starfruit` | Starfruit |
| `frost_essence` | `mint` | Mint |

- **Migration scope**: inventory keys, compendium items list, hotbar references
- **INGREDIENT_RENAMES** const in `network_manager.gd` maps old → new
- **All references updated**: recipe `.tres` files, creature drop tables, trainer rewards, NPC gifts/trades, shop listings, world item spawns, excursion loot, farm drops
- **If adding new ingredient renames**: add to the `INGREDIENT_RENAMES` dict — the backfill function handles the rest automatically

## Multiplayer Join/Spawn Stabilization
- **Client pre-loads GameWorld on connect**: `_on_connected_to_server()` calls `GameManager.start_game()` BEFORE `request_join`. This ensures the MultiplayerSpawner exists before spawn replication RPCs arrive.
- **Name uniqueness**: `active_player_names` dict (name → peer_id) rejects duplicate online names. `_join_rejected` RPC tells client why.
- Spawn waits for client world path readiness (`/root/Main/GameWorld/Players/MultiplayerSpawner`).
- Server tracks temporary join state and times out peers that never become ready.
- **New player spread spawn**: Players with no saved position spawn in a golden-angle circle (radius 2, center 0,0,3) to avoid overlap.

## Player/Camera Notes
- Player movement uses server authority with replicated input.
- Camera defaults to over-the-shoulder and captures mouse during world control. Mouse made visible during battle UI and recaptured after.
- **Server has no camera or UI** — `game_world.gd` `_ready()` skips `_setup_ui()` and `_ensure_fallback_camera()` on the server.
- **Player collision layers**: Players use `collision_layer=2`, `collision_mask=1`. TallGrass and TrainerNPC Area3Ds set `collision_mask=3` (bits 1+2) to detect players.
- **UI node sharing**: `_setup_ui()` adds HUD, BattleUI, CraftingUI, InventoryUI, PartyUI to the **existing** `$UI` node from `game_world.tscn`. Do NOT create a new "UI" node — Godot will rename it, breaking path lookups.
- **Player visuals** (color, nameplate): set on the player node server-side **before** `add_child()` in `_spawn_player()`, synced via StateSync spawn-only mode.
- **StateSync properties** (9 total): `position`, `velocity` (always), `player_color`, `player_name_display` (spawn-only), `mesh_rotation_y` (always), `is_busy` (always), `movement_state` (always), `anim_move_speed` (always), `anim_action` (always).
- **Character vibration/clipping (DO NOT REVERT)**: `_update_crouch_collision()` in `player_controller.gd` (line ~578) runs every physics frame and lerps BOTH `capsule.height` AND `collision_shape.position.y` (= height/2.0). Without the Y position adjustment, the capsule bottom lifts off the floor → `is_on_floor()` returns false → gravity pulls down → oscillation loop. This affects both crouching AND walking if the collision shape Y drifts. The radius also scales: `clamp(height / 3.6, 0.28, 0.5)`. Scene defaults: height=1.8, radius=0.5, CollisionShape3D y=0.9.

## Animation System
- **Architecture**: AnimationTree used as standalone AnimationMixer (NOT paired with a separate AnimationPlayer). Animation library loaded directly via `anim_tree.add_animation_library()`, root_node set to `../CharacterModel`.
- **Why standalone**: In Godot 4.x, AnimationTree with a separate AnimationPlayer via `anim_player` path silently fails to drive Skeleton3D bone poses through blend trees. Using AnimationTree as its own AnimationMixer avoids this.
- **Animation library**: `assets/animations/player_animation_library.tres` — 18 animations built from standalone animation GLBs via `tools/build_animation_library.gd`. Track paths: `RootNode/Skeleton3D:bone_name`.
- **GLB structure**: `CharacterModel > RootNode > Skeleton3D` (65 Mixamo bones with `mixamorig_` prefix).
- **Blend tree**: Two-level state machine — Stance (stand/crouch) → Standing locomotion (Idle/Jog/Run) + Crouch locomotion (CrouchIdle/CrouchWalk). Jump/Fall/Land layered on top.
- **Sync**: Server sets `movement_state`, `anim_move_speed`, `anim_action` on the player node. StateSync replicates to all clients. Each client's AnimationTree reads these to drive animations locally.
- **Loop modes**: Locomotion animations (idle, jog, run, walk, crouch, falling) set to `LOOP_LINEAR` at runtime in `_build_animation_tree()`.
- **Transition request type**: AnimationNodeTransition `transition_request` expects `String`, NOT `StringName` — using StringName causes "Type mismatch" error.
- **Key files**: `scripts/player/player_controller.gd` (`_build_animation_tree()`, `_update_animation_tree()`), `scenes/player/player.tscn`, `tools/build_animation_library.gd`.

## Battle System
- **3 battle modes**: Wild, Trainer (7 NPCs), PvP (V key challenge within 5 units)
- **21 creatures**, 57 moves, 20 abilities, 18 held items, 6 battle items. MAX_PARTY_SIZE = 3
- **Starter**: Rice Ball (Grain, Lv 5, 45 HP) with grain_bash, quick_bite, bread_wall, syrup_trap
- **AI**: 3 tiers (easy=random, medium=type-aware, hard=damage-calc + prediction)
- **PvP**: Both-submit simultaneous turns, 30s timeout, disconnect = forfeit. Loser forfeits 25% ingredients.
- **Defeat penalty**: 50% money loss, teleport to spawn point, all creatures healed
- **Server-authoritative**: `_build_party_from_store(peer_id)` reads from `player_data_store`, NOT client. Party deep-copy via `.duplicate(true)`.
- **Move validation**: `request_battle_action()` verifies move_id in creature's moveset. Switch targets bounds-checked.
- **Rewards RPCs**: `_grant_battle_rewards`, `_send_xp_results`, `_grant_trainer_rewards_client`, `_battle_defeat_penalty`

See `docs/battle-system.md` for full details: IVs (formula, 0-31 range), bond levels (thresholds, modifiers), crit stages, taunt/trick room/substitutes, MoveDef properties, battle UI layout, battle items (HP values), XP/leveling.

## Crafting & Item System
- **67 recipes**: 13 creature (cauldron), 18 held item (workbench), 18 food (kitchen), 9 tool upgrade (workbench), 6 battle item (kitchen), 3 other
- **6 item types**: ingredients (34), held items (18), foods (20), tools (16), recipe scrolls (13), battle items (6) — single inventory namespace
- **3 crafting stations**: Kitchen (restaurant), Workbench (near spawn), Cauldron (deep wild) — filtered by `station` field
- **Crafting security**: Single-phase server-authoritative — `request_craft(recipe_id)` validates server-side, deducts, produces, syncs. No client-side deduction.
- **Tool upgrades**: 3 types (hoe, axe, watering_can) x 4 tiers (basic→bronze→iron→gold)
- **Food buffs**: 4 buff types (speed_boost, xp_multiplier, encounter_rate, creature_heal), timed, server-side expiry every 5s
- **Farming**: `request_farm_action(plot_idx, action, seed_id)` RPC. Server deducts seeds, rolls back on failure.

See `docs/crafting-items.md` for full details: buff application points, PlayerData tool system, selling, recipe unlocks, ingredient details.

## World Systems
- **Hub area**: Spawn near (0,1,3). Farm zone at (25,0,0). Restaurant doors at z=12.
- **6 encounter zones**: Herb Garden, Flame Kitchen, Frost Pantry, Harvest Field, Sour Springs, Fusion Kitchen
- **7 trainers**: 5 optional (Pepper, Green, Dulce, Vlad, Michelin), 2 gatekeepers (Umami, Roux). E-key prompt, `request_challenge` RPC.
- **WorldItemManager**: Server-authoritative pickup via Area3D `body_entered`. Node naming: `"WorldItem_" + str(uid)`. World items rendered as kawaii gift box (Synty present model) with toon shader, sparkle particles, and gentle pulse animation.
- **Restaurant**: Per-player instances at `Vector3(1000+idx*200,0,1000)`. Auto-save position fix checks `RestaurantManager.overworld_positions`. Farm routing via `get_farm_manager_for_peer(peer_id)`.
- **3 shops**: General Store, Battle Supplies, Rare Goods. `request_buy/sell_item` RPCs. Sets busy state.
- **Trading**: T key, 5-unit range. Atomic swap via `_execute_trade()`. Sets busy state. Supports creature offers (party/storage) + receive preferences.
- **Busy state**: `is_busy: bool` on player, StateSync always mode. Guards encounters, PvP, trainers, shop, trade.

See `docs/world-systems.md` for full details: trainer difficulty colors, gatekeeper mechanics, world item lifecycle, restaurant architecture, shop/trade RPCs, creature trading, friend system.

## NPC Social System
- **Friendship**: -100 to +100 per NPC, 5 tiers (hate/dislike/neutral/like/love)
- **Talk**: +2 daily bonus (once/NPC/day), branching dialogue with choices
- **Gifts**: 1/NPC/day. loved(+15), liked(+8), neutral(+3), disliked(-8), hated(-15). 3x birthday.
- **Daily decay**: -1/day (floor 0). NPC gift thresholds at 20/50/80.
- **5 NPCs**: Baker Brioche, Sage Herbalist, Old Salt, Ember Smith, Professor Umami — each with optional creature trade offers
- **NPC creature trades**: Data-driven (`npc_def.creature_trades` array). Gated by friendship tier, season, quest, one-time flag. Server validates + deducts cost items/money, creates creature via `server_give_creature()`.
- **Architecture**: SocialManager (no `class_name`). Key RPCs: `request_talk` → `_send_dialogue`, `request_give_gift` → `_gift_response`.

See `docs/social-quests.md` for full details.

## Creature Destination Chooser
- **Universal entry point**: `server_give_creature(peer_id, creature_data, source_type, source_id)` handles ALL creature receipts (crafting, NPC trade, P2P trade, battle catches)
- **Party has space**: Creature added directly to party, `_notify_creature_received` RPC
- **Party full**: Stores in `pending_creature_choices[peer_id]`, sends `_show_creature_destination_chooser` RPC
- **CreatureDestinationUI**: CanvasLayer modal with 3 options: Send to Storage, Swap with party member, Release (creature lost)
- **RPC**: `request_creature_destination(choice, swap_party_idx)` — validates bounds, min-party, storage capacity

## Friend & Party System
- **Friend requests**: Send/accept/decline/cancel. Works for online + offline players (offline via API PATCH)
- **Blocking**: Block/unblock players. Blocks prevent friend requests, remove existing friendships, auto-kick from shared party
- **Parties**: 4-player max, leader-based invite system. Runtime-only (not persisted). 60s invite TTL.
- **FriendManager**: No `class_name`, child of GameWorld. Server-authoritative with pair-locks on mutations.
- **Social data**: `player_data_store[peer_id]["social"]` = `{friends, blocked, incoming_requests, outgoing_requests}`
- **API**: `PATCH /api/players/:id/social` for atomic offline player social mutations
- **RPCs**: `request_send_friend_request`, `request_accept_friend_request`, `request_create_party`, `request_invite_to_party`. Syncs: `_sync_friends_list`, `_sync_party_state`.
- **MCP testing**: Call `_process_friend_request`, `_do_accept_friend`, `_process_block` directly on server (bypasses `get_remote_sender_id()`). See `docs/friend-party-system.md`.

See `docs/friend-party-system.md` for full details: data model, RPC reference, offline mutations, MCP integration testing procedures.

## Quest System
- **Data-driven**: QuestDef Resource (`class_name QuestDef`), 6 quests (3 main story, 1 side, 1 daily, 1 weekly)
- **QuestManager**: Server-authoritative, no `class_name`. Daily/weekly auto-reset via SeasonManager.
- **Objectives**: Cumulative (defeat_trainer/creature/pvp, discover_location, talk_to, craft, collect) via `notify_progress()`. Inventory-check (deliver) at turn-in.
- **Integration hooks**: BattleManager, CraftingSystem, LocationManager, SocialManager, NetworkManager
- **Rewards**: money, items, friendship, recipe scrolls, unlock flags. Atomic. Delivery items consumed.
- **Quest chains**: `next_quest_id` auto-offers. `chapter` + `sort_order` for main story.
- **QuestLogUI**: J key, layer 10. Tabs: Active/Completed/Main Story. Sets busy.
- **Player state**: `player_data_store[peer_id]["quests"]` = `{active, completed, daily_reset_day, weekly_reset_day, unlock_flags}`
- **RPCs**: Client→Server: `request_available/accept/complete/abandon_quest`. Server→Client: `_send_available_quests`, `_sync_quest_state`, `_notify_quest_progress/complete`, `_offer_next_quest`.

See `docs/social-quests.md` for full details (prereq types, NPC indicators, exploit prevention).

## Excursion System
- **Party-gated procedural zones**: 80x80 terrain, 15-minute timer, per-party isolated instances
- **ExcursionManager**: No `class_name`, child of GameWorld. Instance lifecycle, entry/exit, shared loot routing, timeout.
- **ExcursionGenerator**: `class_name`, static functions. Deterministic terrain from seed + season using FastNoiseLite. Server gets collision only; clients reconstruct visuals from seed.
- **Entrance**: Portal Area3D at `Vector3(-15, 0, 0)`. Party leader triggers entry. Non-leaders see "waiting" message. Solo players told to form a party.
- **Entry validation**: Party required, leader only, all members online + not busy/in-battle/in-restaurant/in-excursion, max 10 instances.
- **Shared loot**: Battle drops + world item pickups + harvestable drops + dig spot finds distributed to ALL current `instance.members`. XP not shared (battling player only). Excursion bonus drops: 15% chance ingredient, 5% chance seed per battle victory.
- **Harvestables**: ~8-12 per instance (trees/rocks/bushes), biome-based placement, richer drop tables than overworld. Shared loot via `_on_excursion_harvest()`. Deterministic from seed (created on both server and client).
- **Dig spots**: 3-5 per instance in valleys, require shovel, excursion-exclusive rare loot. Shared loot via `_on_excursion_dig()`. Unique spot_ids prevent overworld cooldown conflicts.
- **Late-join**: New party members added to `allowed_player_ids`. `request_excursion_late_join` RPC. Loot only from join moment forward.
- **Exit triggers**: Voluntary (button/portal), disconnect, timeout (15 min), party kick/disband. Overworld position restored.
- **FriendManager signals**: `party_member_removed(party_id, player_id, reason)`, `party_member_added(party_id, player_id)` — used by ExcursionManager.
- **Encounter tables**: `excursion_common` (Lv 10-20, uncommon species), `excursion_rare` (Lv 18-35, rare/legendary species including Sushi Samurai).
- **Excursion-exclusive items**: golden_seed, mystic_herb, starfruit, truffle_shaving, ancient_grain_seed, wild_honey, rainbow_creature (food), excursion_berry (food).
- **ExcursionHUD**: CanvasLayer (layer 6). Timer countdown, member count, leave button. Time warnings at 2 min and 30 sec.
- **RPCs**: Client→Server: `request_enter/exit_excursion`, `request_excursion_late_join`. Server→Client: `_enter/_exit_excursion_client`, `_excursion_status_update`, `_excursion_time_warning`, `_grant_excursion_battle_rewards`, `_notify_excursion_harvest`, `_notify_excursion_dig`.

See `docs/excursion-system.md` for full details.

## Networking Rules (IMPORTANT)

This is a server-authoritative multiplayer game. **Every gameplay change — new feature, new action, new resource, any UI that affects game state — must be evaluated for networking impact.** If the user does not specify whether a change should be networked, always ask before implementing.

### Questions to resolve before writing code
- Should this run on **server only**, **client only**, or **both**?
- Does the server need to **validate/authorize** this action? (Almost always yes for anything that changes player data, inventory, party, or world state.)
- Do other clients need to **see the result**? If so, how is it synced — RPC, MultiplayerSynchronizer property, or MultiplayerSpawner?
- Is there a **race condition** if the client optimistically updates before the server confirms?

### Authority model
| System | Authority | Sync mechanism |
|--------|-----------|---------------|
| Player movement/rotation | Server (`_physics_process`) | StateSync (position, velocity, mesh_rotation_y) |
| Player visuals (color, name) | Server (set before spawn) | StateSync (spawn-only) |
| Camera / input | Client (InputSync) | InputSync → server reads |
| Inventory changes | Server (`server_add/remove_inventory`) | RPC to client |
| Farm actions (plant/water/harvest/till) | Server (`request_farm_action` RPC) | Server validates, then RPC result to client |
| Battle state | Server (BattleManager) | RPCs to involved clients |
| Crafting | Server (`request_craft` single-phase) | RPC results + inventory sync to client |
| Food/buffs | Server (`request_use_food`) | `_sync_active_buffs` RPC to client |
| Tool/held item equip | Server (`request_equip_*` RPCs) | Sync RPCs to client |
| World item spawn/pickup | Server (WorldItemManager) | `_spawn/_despawn_world_item_client` RPCs to all |
| Restaurant entry/exit | Server (RestaurantManager) | `_notify_location_change` RPC |
| Calendar/weather | Server (SeasonManager) | `_broadcast_time(year, month, day, total_days, weather)` RPC to all |
| Calendar board | Server (CalendarBoard) | `_open_calendar_client` RPC to requesting peer |
| Shop buy/sell | Server (`request_buy/sell_item` RPCs) | Server validates + syncs inventory via RPC |
| Player trading (items) | Server (atomic swap in `_execute_trade`) | RPCs for offer updates, confirm, cancel |
| Creature trading (P2P) | Server (`_execute_trade` with creature offers) | `_sync_trade_creatures`, `_trade_completed_client` RPCs |
| Creature trading (NPC) | Server (SocialManager) | Dialogue choice RPC, `_notify_creature_received` |
| Creature destination | Server (`server_give_creature`) | `_show_creature_destination_chooser`, `request_creature_destination` RPCs |
| Friend system | Server (FriendManager) | `_sync_friends_list`, `_friend_action_result` RPCs |
| Party system | Server (FriendManager) | `_sync_party_state`, `_notify_party_invite` RPCs |
| Busy state | Server (`request_set_busy` RPC) | StateSync (always mode) on player node |
| NPC friendship | Server (SocialManager) | RPCs: `_sync_npc_friendships`, `_send_dialogue`, `_gift_response` |
| Quest system | Server (QuestManager) | RPCs: `_sync_quest_state`, `_notify_quest_progress`, `_notify_quest_complete` |
| Location discovery | Server (LocationManager) | `_notify_location_discovered` RPC to client |
| Compass/minimap rendering | Client only | Reads local camera_yaw + cached LocationDef positions |
| Stats/compendium | Server (StatTracker static calls) | On-demand `_sync_compendium_client` RPC when UI opens |
| Save/load | Server only (SaveManager → Express API → MongoDB) | Data sent to client via `_receive_player_data` |
| Excursion entry/exit | Server (ExcursionManager) | `_enter/_exit_excursion_client` RPCs, seed+season for terrain |
| Excursion loot | Server (ExcursionManager routes) | `_grant_excursion_battle_rewards` + `_notify_pickup` RPCs per member |
| Excursion terrain visuals | Client (ExcursionGenerator from seed) | No sync needed |
| Player animation | Client (AnimationTree blend tree) | Server syncs `movement_state`, `anim_move_speed`, `anim_action` via StateSync |

### Never do this
- **Never deduct resources client-side before server confirms.** Always let the server deduct first, then sync to client via RPC. The old planting flow had this bug — client removed seed, then told server, creating desync on disconnect.
- **Never assume a gameplay feature is local-only** unless explicitly told so. Even "cosmetic" things like player color need syncing in multiplayer.
- **Never modify `PlayerData` (the autoload) on the server.** `PlayerData` is the client's local mirror. The server uses `NetworkManager.player_data_store[peer_id]`. Sync changes from server store to client PlayerData via RPC.

## Location, Compass & Calendar
- **28 LocationDefs** (`resources/locations/*.tres`): landmarks with position, discovery_radius, category, icon_color
- **LocationManager** (no `class_name`): Server-side, checks proximity every 10 physics frames. Skips restaurant players.
- **Discovery flow**: Server detects → appends to `player_data_store` → `_notify_location_discovered` RPC → client HUD toast
- **Compass**: North=-Z, bearing via `atan2(dx,dz)`. CanvasLayer (layer 5), target dropdown by category. Undiscovered locations shown as dimmed markers (6x4 px, 40% alpha) at top of strip.
- **Minimap**: `Control._draw()`, all locations visible (discovered=filled icons, undiscovered=outlined with "???"), category legend, scroll wheel zoom, click-to-target. Pause Overlay: Esc/M key, layer 15.
- **Calendar**: 12 months (Jan-Dec), 28 days/month, 336 days/year, start March. `DAY_DURATION = 600.0` (10 min).
- **Seasons**: Mar-May=spring, Jun-Aug=summer, Sep-Nov=autumn, Dec-Feb=winter
- **Weather**: Sunny(50%), Rainy(25%), Windy(15%), Stormy(10%). Rain auto-waters farms.
- **Sync**: `_broadcast_time(year, month, day, total_days, weather)` RPC. Late-joiners: `request_season_sync`.
- **CalendarBoard**: Area3D at `Vector3(5,0,5)`. CalendarUI: 28-day grid. CalendarEvents: 10 holidays + birthdays.

See `docs/location-calendar.md` for full details.

## Compendium & Stat Tracking
- **StatTracker** (`class_name`, static `_store` via `init(player_data_store)` in NetworkManager._ready())
- **Data**: `"stats"` (flat counters + per-species dicts) and `"compendium"` (items, creatures_seen, creatures_owned)
- **~30 stats**: battles, XP, money, crafting, farming, social, quests, locations, days
- **Compendium unlocks**: Items on first obtain, creatures "seen" in battle / "owned" on craft
- **Hook integration**: StatTracker calls in battle_manager, network_manager, crafting_system, farm_manager, social_manager, quest_manager, location_manager, season_manager
- **Sync**: `request_compendium_sync.rpc_id(1)` → `_sync_compendium_client(stats, compendium)`
- **CompendiumUI**: K key, layer 10. 3 tabs: Items (7 sub-filters), Creatures (seen/owned), Stats.

See `docs/compendium-stats.md` for full tracked stat list and hook locations.

## UI Theme & Accessibility
- **UITokens** (`scripts/ui/ui_tokens.gd`): Static color palette, font size constants (`FONT_H1`=36 through `FONT_TINY`=16), layout constants. No `class_name` — preloaded where needed.
- **UITheme** (`scripts/ui/ui_theme.gd`): `class_name UITheme`. Semantic styling API (`style_title`, `style_body`, `style_button`, etc.), font loading, font scale + text speed state, icon creation.
- **Font scaling**: `UITheme.scaled(size)` multiplies any base font size by `_font_scale` (default 1.0). All UI code MUST use `UITheme.scaled(UITokens.FONT_*)` — never raw `UITokens.FONT_*` for runtime font sizes. Label3D in 3D scenes (battle arena, world labels) also use `UITheme.scaled()`.
- **Text speed**: `UITheme.get_text_speed()` returns chars/sec (-1 = instant). Used by dialogue/trainer UI for typewriter effect.
- **Settings persistence**: `user://settings.cfg` via ConfigFile. Saves both float values (`font_scale`, `text_speed_cps`) and integer indices (`font_scale_idx`, `text_speed_idx`). Load prefers index keys, falls back to float lookup for backward compat.
- **4 font scale steps**: Small (0.85), Normal (1.0), Large (1.15), Extra Large (1.3)
- **4 text speed steps**: Slow (20 cps), Normal (40 cps), Fast (80 cps), Instant (-1)
- **Settings UI**: `scripts/ui/tabs/settings_tab.gd` — slider-based, in pause menu Settings tab.
- **Fonts**: Lilita One (headings), Fredoka One (body). Loaded in `UITheme.init()`.

See `docs/ui-accessibility.md` for full details.

## Icon System (Synty POLYGON_Icons + Kawaii Shader)
- **Source**: 520 Synty POLYGON_Icons `.glb` meshes in `assets/synty_icons/Models/`, shared color palette atlas in `assets/synty_icons/Textures/`.
- **Pre-baked pipeline**: Icons are rendered at editor time via `tools/bake_icons_cli.gd` (SceneTree script), NOT runtime SubViewports. Zero runtime cost — icons are static 256x256 PNGs with transparent backgrounds.
- **Shader stack**: `shaders/toon_icon.gdshader` (kawaii cel shader with pastel remap, two-tone light/shadow, rim light) + `shaders/icon_outline.gdshader` (inverted hull outline in soft purple-brown) + `shaders/icon_postprocess.gdshader` (optional bloom/vignette/color grading).
- **Output**: `assets/ui/textures/icons/<category>/<item_id>.png` — subdirs: `ingredients/`, `foods/`, `tools/`, `battle_items/`, `held_items/`, `ui/`.
- **Data layer**: All item defs (`IngredientDef`, `FoodDef`, `ToolDef`, `BattleItemDef`, `RecipeScrollDef`, `HeldItemDef`) have `@export var icon_texture: Texture2D`. `DataRegistry.get_item_display_info()` returns both `icon_color` and `icon_texture`.
- **UI helper**: `UITheme.create_item_icon(info, base_size)` — returns `TextureRect` if `icon_texture` exists, falls back to `ColorRect` with `icon_color`. All sizes use `UITheme.scaled()`. Used by: `inventory_tab.gd`, `shop_ui.gd`, `trade_ui.gd`, `hotbar_ui.gd`.
- **Hotbar**: `slot_icons: Array[Control]` dynamically swaps between TextureRect/ColorRect per slot via `_set_slot_icon()`.
- **Re-bake command**: `'/Applications/Mechanical Turk.app/Contents/MacOS/Mechanical Turk' --path . --script tools/bake_icons_cli.gd`
- **Adding new icons**: Add entry to `icon_manifest` in `tools/bake_icons_cli.gd`, re-bake, assign PNG to `.tres` file's `icon_texture` field.
- **No networking impact**: Icons are client-side only (textures loaded from `res://`). No sync needed.

## GDScript Conventions
- Use `class_name` for static utility classes (BattleCalculator, StatusEffects, FieldEffects, AbilityEffects, HeldItemEffects, BattleAI, StatTracker)
- Do NOT preload scripts that already have `class_name` — causes "constant has same name as global class" warning
- Prefix unused parameters/variables with `_` to suppress warnings
- Use `4.0` instead of `4` in division to avoid integer division warnings

## Export Build Gotchas
- **DataRegistry .tres/.remap handling**: Godot exports convert `.tres` to `.tres.remap`. Any code using `DirAccess` to scan for resources must check `.tres`, `.res`, AND `.remap` extensions.
- **Battle stacking prevention**: All encounter/battle entry points must check `BattleManager.player_battle_map` before starting a new battle. Client-side `start_battle_client()` also guards against duplicate RPCs.
- **stdbuf for Docker logs**: Godot headless buffers stdout. Dockerfile uses `stdbuf -oL` for line-buffered output.
- **Duplicate node name trap**: If a .tscn already has child "X", creating a new `Node("X")` + `add_child()` causes silent rename. Always use `get_node("X")` for existing nodes.
- **CanvasLayer child visibility**: CanvasLayer's `visible = false` does NOT propagate to child Controls — they still report `visible = true`. When checking if a CanvasLayer-based UI is open, always check the CanvasLayer's own `.visible` first. Hiding children requires explicit restore on next use. `_on_battle_started()` restores all children.
- **MCP addon excluded from server export**: `export_presets.cfg` has `exclude_filter="addons/mechanical_turk_mcp/*"`. Non-fatal "File not found" on startup is expected.
- **Connection timeout**: ConnectUI has a 10-second timeout for transport-connected but multiplayer-rejected peers.

## Kubernetes Deployment
See `docs/k8s-deployment.md` for full K8s deployment details (3 deployments, SSH access, deploy workflow, manifests).

## Automated Testing
See `docs/testing-guide.md` for full test suite details, file listings, and file structure overview.

### Run Commands
```bash
# GDScript tests (GUT)
'/Applications/Mechanical Turk.app/Contents/MacOS/Mechanical Turk' --path . --headless -s addons/gut/gut_cmdln.gd -gexit

# Express API tests (Vitest)
cd api && npx vitest run
```

### Test Patterns
- **RegistrySeeder**: `seed_all()` in `before_each()`, `clear_all()` in `after_each()`
- **BattleFactory**: `creature(overrides)` and `battle(overrides)` with sensible defaults
- **MockMove**: `physical()`, `special()`, `status()`, `with_props(overrides)`
- **Deterministic RNG**: Use `seed(N)` for reproducible results
- **No preloading**: Reference `class_name` utilities directly — never preload in tests
- **SeasonManager testing**: Load script onto standalone Node, set state directly, don't add to tree
- **New battle mechanic**: Add tests to `test/unit/battle/`. Update `registry_seeder.gd` if needed.
- **New data type**: Add round-trip tests in `test/unit/data/`.
- **Run tests before committing**: All tests must pass.

## MCP Testing Workflow
See `docs/mcp-testing.md` for full MCP testing guide (editor bridge, runtime bridge sessions, caveats, port conflicts).
