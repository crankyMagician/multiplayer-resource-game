# Persistence Architecture (MongoDB + Express API)

## Architecture
```
[Godot Game Server] --HTTP--> [Express API :3000] --MongoDB--> [MongoDB :27017]
     |                              (internal only)
     |--UDP 7777--> [Game Clients]
```
- Only the game server talks to the API. Clients get data via RPCs.
- API is internal (ClusterIP in K8s, docker network locally).
- **Editor dev (no Docker)**: SaveManager auto-falls back to file I/O (`user://save/`). No API needed.

## UUID Identity System

**Every persistent entity MUST have a stable UUID.** MongoDB documents are keyed by UUID, not by name or array index.

| Entity | UUID field | Generated by | Stored in |
|--------|-----------|-------------|-----------|
| Player | `player_id` | Express API (`crypto.randomUUID()`) on first join | `players` collection `_id`, `player_data_store[peer_id]["player_id"]` |
| Creature | `creature_id` | Server-side `_generate_uuid()` on creation | Each creature dict in party/storage arrays |

**Rules for UUIDs:**
- **New entities** (players, creatures, future items): ALWAYS generate a UUID on creation. Never rely on array index or display name as an identifier.
- **Existing entities without UUIDs**: Auto-backfilled on load via `_backfill_creature_ids()`. Same function also backfills IVs, bond data via `_backfill_creature_stats()`.
- **Cross-reference by UUID**: Held item equip/unequip, storage deposit/withdraw, battle creature references should use `creature_id` (not party index).
- **Player names are unique** (MongoDB unique index + `active_player_names` runtime check) but names are for display/lookup, NOT identity. The `player_id` UUID is the stable key.
- **If you add a new persistent entity type** (e.g. guilds, mail, auction listings), it MUST get a UUID field generated server-side.

## Express API (`api/`)

- **Tech**: Node 20, Express, MongoDB driver, TypeScript
- **Endpoints**: `GET/PUT /api/players/:id`, `GET /api/players/by-name/:name`, `POST /api/players`, `GET/PUT /api/world`, `GET /health`
- **MongoDB collections**: `players` (keyed by `_id: player_id` UUID, unique index on `player_name`), `world` (single doc `_id: "world_state"`)
- **Image**: `ghcr.io/crankymagician/mt-creature-crafting-api:latest`

## SaveManager (`scripts/autoload/save_manager.gd`)

- **Startup**: checks `SAVE_API_URL` env var → `GET /health` → sets `use_api: bool`. Falls back to file I/O if unreachable.
- **Save flow**: `save_player(data)` → `PUT /api/players/:player_id` (fire-and-forget, auto-save every 60s)
- **Load flow**: `load_player_async(name)` → `GET /api/players/by-name/:name` → emits `player_loaded(name, data)`
- **Create flow**: `create_player_async(data)` → `POST /api/players` → API generates UUID → emits `player_created(name, data)`

## Join Flow (Async, UUID-Aware)

1. Client sends `request_join(player_name)` RPC
2. Server validates name (2-16 chars, alphanumeric + underscores + spaces), checks `active_player_names`
3. Server calls `SaveManager.load_player_async(player_name)` → signal
4. If empty → `create_player_async()` (new player with UUID); if found → `_finalize_join()`
5. `_finalize_join()`: backfills creature UUIDs + IVs + bond data, stores in `player_data_store`, sends `_receive_player_data` RPC

## Docker Compose (Local Dev)

```yaml
services:
  mongodb:     # mongo:7, port 27017, volume mongo_data
  api-service: # builds ./api, port 3000, MONGO_URI
  game-server: # builds ., port 7777/udp, SAVE_API_URL
```
- `docker compose up --build -d` starts all 3 services
- Verify MongoDB: `docker exec mongodb mongosh creature_crafting --eval "db.players.find()"`

## Ingredient Renames (Migration System)

8 fantasy ingredient IDs were renamed to real cooking terms. Old saves are auto-migrated on login via `_backfill_ingredient_renames(data)` in `_finalize_join()`.

| Old ID | New ID | Display Name |
|--------|--------|-------------|
| `grain_core` | `flour` | Flour |
| `sweet_crystal` | `sugar` | Sugar |
| `umami_extract` | `soy_sauce` | Soy Sauce |
| `herbal_dew` | `broth` | Broth |
| `sour_essence` | `vinegar` | Vinegar |
| `spicy_essence` | `chili_powder` | Chili Powder |
| `starfruit_essence` | `starfruit` | Starfruit |
| `frost_essence` | `mint` | Mint |

- **Migration scope**: inventory keys, compendium items list (hotbar data auto-cleaned from legacy saves)
- **All references updated**: recipe `.tres` files, creature drop tables, trainer rewards, NPC gifts/trades, shop listings, world item spawns, excursion loot, farm drops
- **If adding new ingredient renames**: add to the `INGREDIENT_RENAMES` dict in `network_manager.gd` — the backfill function handles the rest automatically
